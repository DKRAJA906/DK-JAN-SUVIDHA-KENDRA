<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advance PDF Text Editor - DK Jan Suvidha</title>
    <!-- CSS for Text Layer -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf_viewer.min.css">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <style>
        body { background: #525659; margin: 0; font-family: sans-serif; }
        
        #toolbar {
            background: #fff; padding: 10px 20px; display: flex; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 999;
        }
        
        #pdf-wrapper {
            position: relative; margin: 20px auto; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background: white;
        }

        /* Text Layer (Jahan text dikhega) */
        .textLayer {
            position: absolute; left: 0; top: 0; right: 0; bottom: 0;
            overflow: hidden; opacity: 1; line-height: 1.0;
        }

        /* Text Spans (Jo text asli PDF mein hai) */
        .textLayer span {
            color: transparent; /* Asli text ko chupao */
            position: absolute; white-space: pre; cursor: text;
            transform-origin: 0% 0%;
        }

        /* Selection Box (Jab click karein) */
        .editable-box {
            position: absolute; background: white; border: 1px solid #007bff; 
            z-index: 100; padding: 0; margin: 0; outline: none;
            color: black; font-family: sans-serif;
        }
        
        .btn { padding: 8px 15px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; margin-right: 10px; }
    </style>
</head>
<body>

<div id="toolbar">
    <input type="file" id="fileInput" accept="application/pdf" style="display:none">
    <button class="btn" onclick="document.getElementById('fileInput').click()">1. Upload PDF</button>
    <button class="btn" style="background:#28a745" onclick="downloadPDF()">2. Download Edited PDF</button>
    <span style="margin-left:auto; font-size:14px; color:#333;">üí° ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç</span>
</div>

<div id="pdf-wrapper">
    <canvas id="the-canvas"></canvas>
    <div id="text-layer" class="textLayer"></div>
</div>

<script>
    // Variables
    let pdfDoc = null;
    let pdfBytes = null;
    let scale = 1.5;
    let textItems = []; // Saara text yahan store hoga
    
    // Worker Set karein
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // 1. Upload & Render Logic
    document.getElementById('fileInput').addEventListener('change', async function(e) {
        let file = e.target.files[0];
        if (file) {
            pdfBytes = await file.arrayBuffer();
            loadPDF(pdfBytes);
        }
    });

    async function loadPDF(data) {
        const loadingTask = pdfjsLib.getDocument(data);
        pdfDoc = await loadingTask.promise;
        const page = await pdfDoc.getPage(1); // Sirf pehla page abhi ke liye

        // A. Render Canvas (Image Layer)
        const viewport = page.getViewport({ scale: scale });
        const canvas = document.getElementById('the-canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const wrapper = document.getElementById('pdf-wrapper');
        wrapper.style.width = `${viewport.width}px`;
        wrapper.style.height = `${viewport.height}px`;

        await page.render({ canvasContext: context, viewport: viewport }).promise;

        // B. Render Text Layer (Magic Layer)
        const textContent = await page.getTextContent();
        const textLayerDiv = document.getElementById('text-layer');
        textLayerDiv.innerHTML = ''; // Clear purana text
        
        // CSS Variables set karein taaki text sahi jagah baithe
        textLayerDiv.style.height = viewport.height + 'px';
        textLayerDiv.style.width = viewport.width + 'px';

        // PDF.js ka TextLayer render karein
        pdfjsLib.renderTextLayer({
            textContent: textContent,
            container: textLayerDiv,
            viewport: viewport,
            textDivs: []
        });

        // C. Har text ko "Editable" banayein
        // Thoda wait karein taaki DOM ban jaye
        setTimeout(() => {
            const spans = textLayerDiv.querySelectorAll('span');
            spans.forEach(span => {
                // Asli text dikhayein (Transparent hata kar) lekin uske peeche white background laga dein
                // Taaki asli canvas ka text chup jaye
                span.style.color = 'transparent'; // Pehle transparent rakhein
                
                // Click Event - Jab user click kare
                span.onclick = function(e) {
                    e.stopPropagation();
                    makeEditable(this, viewport);
                };
            });
        }, 500);
    }

    function makeEditable(spanElement, viewport) {
        // Purana input agar koi khula ho to band karein
        const oldInput = document.querySelector('.editable-box');
        if(oldInput) oldInput.remove();

        // Naya Input banayein
        const input = document.createElement('input');
        input.type = 'text';
        input.value = spanElement.textContent; // Asli text input mein daalein
        input.className = 'editable-box';
        
        // Position set karein (Span ke bilkul upar)
        input.style.left = spanElement.offsetLeft + 'px';
        input.style.top = spanElement.offsetTop + 'px';
        input.style.width = (spanElement.offsetWidth + 20) + 'px'; // Thoda bada
        input.style.height = spanElement.offsetHeight + 'px';
        input.style.fontSize = spanElement.style.fontSize;
        input.style.fontFamily = spanElement.style.fontFamily;
        
        // Isse "Edited" mark karein taaki baad mein save kar sakein
        input.dataset.originalX = spanElement.offsetLeft; 
        input.dataset.originalY = spanElement.offsetTop; 
        
        // Add to DOM
        document.getElementById('text-layer').appendChild(input);
        input.focus();

        // Save on Blur (Bahar click karne par save maanein)
        input.onblur = function() {
            // Box ko wahin rehne dein lekin border hata dein taaki saaf dikhe
            input.style.border = 'none';
            input.style.background = 'white'; // Whiteout effect
            // Span ko update na karein, bas input ko final maan lein
        };
    }

    // 2. Save Logic (Browser -> PDF)
    async function downloadPDF() {
        if (!pdfBytes) { alert("PDF load nahi hai!"); return; }

        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        const pdfDocLib = await PDFDocument.load(pdfBytes);
        const page = pdfDocLib.getPages()[0];
        const { height } = page.getSize();
        
        const font = await pdfDocLib.embedFont(StandardFonts.Helvetica);

        // Saare Inputs dhundhein jo user ne banaye hain
        const editedInputs = document.querySelectorAll('.editable-box');
        
        editedInputs.forEach(input => {
            const text = input.value;
            // Coordinates convert karein (HTML -> PDF)
            // Left same rehta hai (Scale divide karein)
            const x = parseFloat(input.style.left) / scale;
            
            // Top ko convert karna padta hai kyunki PDF mein Y neeche se shuru hota hai
            // Formula: PageHeight - (TopPosition / Scale) - FontHeightCorrection
            const y = height - (parseFloat(input.style.top) / scale) - (parseFloat(input.style.fontSize)/scale);

            // 1. White Rectangle (Eraser) - Purana mitane ke liye
            page.drawRectangle({
                x: x, 
                y: y - 2, 
                width: (parseFloat(input.style.width) / scale), 
                height: (parseFloat(input.style.height) / scale) + 5,
                color: rgb(1, 1, 1) // White
            });

            // 2. Naya Text
            page.drawText(text, {
                x: x,
                y: y,
                size: parseInt(input.style.fontSize) / scale, // Font size match karein
                font: font,
                color: rgb(0, 0, 0)
            });
        });

        const pdfData = await pdfDocLib.save();
        const blob = new Blob([pdfData], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'edited_document.pdf';
        link.click();
    }
</script>

</body>
</html>
