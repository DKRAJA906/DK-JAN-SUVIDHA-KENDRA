<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Test - DKJS</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { margin:0; padding:10px; background:#eee; font-family:sans-serif; }
        .toolbar { position:fixed; top:0; left:0; right:0; background:#2c3e50; padding:10px; display:flex; gap:10px; z-index:1000; }
        button { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; color:#fff; background:#3498db; }
        #canvas-container { margin-top:60px; display:flex; justify-content:center; }
        canvas { box-shadow:0 0 10px rgba(0,0,0,0.5); background:#fff; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="file" id="fileInput" accept="application/pdf" style="display:none">
    <button onclick="document.getElementById('fileInput').click()">ðŸ“‚ Open PDF</button>
</div>

<div id="canvas-container">
    <canvas id="c"></canvas>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const canvas = new fabric.Canvas('c');
    let pdfDoc = null;

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        console.log('PDF selected:', file.name);
        const arrayBuffer = await file.arrayBuffer();

        try {
            pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            console.log('PDF loaded, pages:', pdfDoc.numPages);
            alert('PDF loaded: ' + pdfDoc.numPages + ' pages');
            renderPage(1);
        } catch (err) {
            console.error('getDocument error', err);
            alert('getDocument error: ' + err.message);
        }
    });

    async function renderPage(pageNumber) {
        const page = await pdfDoc.getPage(pageNumber);
        console.log('Rendering page', pageNumber);

        const scale = 1.5;
        const viewport = page.getViewport({ scale });

        const hiddenCanvas = document.createElement('canvas');
        const ctx = hiddenCanvas.getContext('2d');

        hiddenCanvas.width  = viewport.width;
        hiddenCanvas.height = viewport.height;

        await page.render({
            canvasContext: ctx,
            viewport: viewport
        }).promise;

        console.log('Page rendered to hidden canvas');

        const bgImage = hiddenCanvas.toDataURL('image/png');

        fabric.Image.fromURL(bgImage, (img) => {
            console.log('Background image loaded in Fabric');
            canvas.setWidth(viewport.width);
            canvas.setHeight(viewport.height);

            img.set({ selectable:false, evented:false });
            img.scaleToWidth(viewport.width);
            img.scaleToHeight(viewport.height);

            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
        }, { crossOrigin: 'anonymous' });
    }
</script>

</body>
</html>
