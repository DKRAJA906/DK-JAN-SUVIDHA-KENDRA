<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desi WPS Editor - By DK Jan Suvidha</title>

    <!-- ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä‡§ú‡§º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 10px;
        }
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            padding: 10px;
            display: flex;
            gap: 10px;
            z-index: 1000;
            overflow-x: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        .btn-upload { background: #3498db; color: white; }
        .btn-eraser { background: #e74c3c; color: white; }
        .btn-text   { background: #f1c40f; color: black; }
        .btn-save   { background: #27ae60; color: white; margin-left: auto; }

        #canvas-container {
            margin-top: 60px;
            display: flex;
            justify-content: center;
            overflow: auto;
            padding-bottom: 50px;
        }
        .canvas-box {
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background: white;
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="file" id="fileInput" accept="application/pdf" style="display:none">
        <button class="btn-upload" onclick="document.getElementById('fileInput').click()">üìÇ Open PDF</button>

        <button class="btn-eraser" onclick="addEraser()">‚¨ú Eraser (Whiteout)</button>
        <button class="btn-text" onclick="addText()">Tb Add Text</button>
        <button onclick="deleteSelected()">üóëÔ∏è Delete Item</button>

        <button class="btn-save" onclick="downloadPDF()">üíæ Save PDF</button>
    </div>

    <div id="canvas-container">
        <canvas id="c" class="canvas-box"></canvas>
    </div>

    <script>
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Fabric canvas
        const canvas = new fabric.Canvas('c');
        let pdfDoc = null;

        // PDF upload
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;

            // ‡§´‡§ø‡§≤‡§π‡§æ‡§≤ ‡§™‡§π‡§≤‡§æ ‡§™‡•á‡§ú
            renderPage(1);
        });

        // High‚ÄëResolution page render (no blur)
        async function renderPage(num) {
            const page = await pdfDoc.getPage(num);

            const baseScale = 1.5; // zoom level
            const outputScale = window.devicePixelRatio || 1; // HiDPI support[web:34][web:50]

            // viewport original size ‡§™‡§∞ (baseScale ‡§ï‡•á ‡§∏‡§æ‡§•)
            const viewport = page.getViewport({ scale: baseScale });

            // Hidden canvas (as bitmap)
            const hiddenCanvas = document.createElement('canvas');
            const context = hiddenCanvas.getContext('2d');

            // bitmap size = viewport * outputScale
            hiddenCanvas.width  = Math.floor(viewport.width  * outputScale);
            hiddenCanvas.height = Math.floor(viewport.height * outputScale);

            // CSS size normal (‡§ú‡•ã ‡§Ü‡§Ç‡§ñ ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ)
            hiddenCanvas.style.width  = Math.floor(viewport.width)  + 'px';
            hiddenCanvas.style.height = Math.floor(viewport.height) + 'px';

            // PDF.js render context with transform (HiDPI)[web:36][web:50]
            const transform = outputScale !== 1
                ? [outputScale, 0, 0, outputScale, 0, 0]
                : null;

            await page.render({
                canvasContext: context,
                viewport: viewport,
                transform: transform
            }).promise;

            const bgImage = hiddenCanvas.toDataURL("image/png");

            fabric.Image.fromURL(bgImage, function(img) {
                // Fabric canvas size = CSS size
                const cssWidth  = viewport.width;
                const cssHeight = viewport.height;

                canvas.setWidth(cssWidth);
                canvas.setHeight(cssHeight);

                // background image ‡§ï‡•ã canvas ‡§ï‡•á ‡§¨‡§∞‡§æ‡§¨‡§∞ ‡§´‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç
                img.set({
                    selectable: false,
                    evented: false
                });
                img.scaleToWidth(cssWidth);
                img.scaleToHeight(cssHeight);

                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            });
        }

        // Eraser (white rectangle)
        function addEraser() {
            const rect = new fabric.Rect({
                left: 100,
                top: 100,
                fill: 'white',
                width: 120,
                height: 35,
                borderColor: 'red',
                cornerColor: 'red',
                strokeWidth: 1,
                stroke: 'red'
            });
            canvas.add(rect);
            canvas.setActiveObject(rect);
        }

        // Add text
        function addText() {
            const text = new fabric.IText('Type Here', {
                left: 150,
                top: 150,
                fontFamily: 'Arial',
                fontSize: 20,
                fill: 'black'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // Delete selected object
        function deleteSelected() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                canvas.remove(activeObj);
            }
        }

        // High‚Äëres PDF download
        function downloadPDF() {
            // High resolution image from Fabric canvas[web:52][web:53]
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 2 // 2x resolution
            });

            const { jsPDF } = window.jspdf;

            const pdf = new jsPDF({
                orientation: canvas.width > canvas.height ? 'l' : 'p',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });

            pdf.addImage(
                dataURL,
                'PNG',
                0,
                0,
                canvas.width,
                canvas.height
            );

            pdf.save("edited-document.pdf");
        }
    </script>
</body>
</html>
